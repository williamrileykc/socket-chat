var main={opSocket:null,operatorConnected:!1,visitorCount:0,initialize:function(){},testForValidMessage:function(e){return""!=e&&void 0!=e},messages:function(e,t){1==main.testForValidMessage(e)&&($("#messages").append($('<li class="'+t+'">').text(e)),main.scrollFix("#messages"))},scrollFix:function(e){$(e).scrollTop(2*$(e).height())}},visitor={Socket:null,activeVisitor:!1,init:function(){visitor.Socket=io(),visitor.Socket.on("connect",function(){}),visitor.Socket.on("operator-connected",function(e){main.operatorConnected=!0,visitor.visitorQueueUpdate(e)}),visitor.Socket.on("operator-disconnected",function(){main.operatorConnected=!1}),visitor.Socket.on("message-to-visitor",function(e){main.messages(e,"them")}),visitor.Socket.on("message-to-operator",function(e){main.messages(e,"me")}),visitor.Socket.on("visitor-connected",function(e){visitor.visitorWelcome(e)}),visitor.Socket.on("you-were-disconnected",function(e){visitor.visitorDisconnected(e)}),visitor.Socket.on("visitor-queue-update",function(e){visitor.visitorQueueUpdate(e)}),visitor.refreshListeners()},addListeners:function(){$("#editNickname").on("submit",visitor.setNickname),$("#sendMessage").on("submit",visitor.messageToOperator)},removeListeners:function(){$("#editNickname").off("submit",visitor.setNickname),$("#sendMessage").off("submit",visitor.messageToOperator)},refreshListeners:function(){visitor.removeListeners(),visitor.addListeners()},setNickname:function(){var e=$("#nickname").val().trim();return""!=e&&($("#editNickname").addClass("hidden"),visitor.Socket.emit("visitor-connected",e)),!1},visitorWelcome:function(e){main.visitorCount=e.count,$("#messages").empty(),$("#messages").append($('<li class="visitor-status">')),null!=e.operator&&(main.operatorConnected=!0),$(".modal").length>0&&$(".modal").hasClass("visible")&&$(".modal").removeClass("visible")},testForOperator:function(){},visitorQueueUpdate:function(e){var t="",o=e.position;1==main.operatorConnected?(t="An operator is connected. ",0==o&&($("#chat-window--visitor").addClass("chatting"),$(".visitor-status").text(t+"How can we help you?")),1==o&&$(".visitor-status").text(t+"You are currently next in line"),o>1&&$(".visitor-status").text(t+"You are currently number "+(main.visitorCount-1)+" in line")):$(".visitor-status").text("There are currently no operators connected")},messageToOperator:function(){return visitor.Socket.emit("message-to-operator",$("#messageField").val()),$("#messageField").val(""),!1},visitorDisconnected:function(e){$("#chat-window--visitor").removeClass("chatting"),$("#messages").append($('<li class="visitor-status">').text("You have been disconnected, please refresh to reconnect"))}},operator={Socket:null,activeVisitor:null,init:function(){operator.Socket=io(),operator.Socket.on("connect",function(){main.operatorConnected=!0,operator.Socket.emit("operator-connected")}),operator.Socket.on("operator-connected",function(e){operator.visitorListPopulate(e)}),operator.Socket.on("operator-disconnected",function(){main.operatorConnected=!1}),operator.Socket.on("message-to-visitor",function(e){main.messages(e,"me")}),operator.Socket.on("message-to-operator",function(e){main.messages(e,"them")}),operator.Socket.on("visitor-connected",function(e){operator.visitorConnect(e)}),operator.Socket.on("disconnect",function(e){operator.socketDisconnect(e)}),operator.refreshListeners()},addListeners:function(){$("#editVisitors").on("submit",operator.visitorNickname),$("#sendMessage").on("submit",operator.messageToVisitor),$(".visitors-window .window--title").on("click",operator.visitorWindowToggle)},removeListeners:function(){$("#editVisitors").off("submit",operator.visitorNickname),$("#sendMessage").off("submit",operator.messageToVisitor),$(".visitors-window .window--title").off("click",operator.visitorWindowToggle)},refreshListeners:function(){operator.removeListeners(),operator.addListeners()},visitorConnect:function(e){$("#visitors").append($('<li data-id="'+e.ID+'" data-nickname="'+e.Nickname+'">').text(e.Nickname)),main.scrollFix("#visitors"),operator.refreshListeners(),operator.updateActiveVisitor()},visitorListPopulate:function(e){$(e).each(function(e,t){operator.visitorConnect(t)})},socketDisconnect:function(e){$("#visitors li").each(function(t,o){$(o).data("id")==e.ID&&$(o).remove(),main.visitorCount=e.count}),operator.updateActiveVisitor()},updateActiveVisitor:function(){$("#visitors li").removeClass("active"),$("#visitors li:first-child").addClass("active"),operator.activeVisitor=$("#visitors li.active").data("id");var e=$("#visitors li.active").data("nickname");$("#messages").empty(),void 0!=e&&$("#messages").append($('<li class="operator-status">').text("You are now connected to "+e))},visitorSelect:function(){$("#visitors li").removeClass("active"),$(this).addClass("active"),operator.activeVisitor=$(this).data("id")},messageToVisitor:function(){var e=$("#messageField").val();return"!next"!=e&&(operator.Socket.emit("message-to-visitor",{username:operator.activeVisitor,message:e}),$("#messageField").val("")),"!next"==e&&(operator.Socket.emit("disconnect-visitor",{ID:operator.activeVisitor}),$("#messageField").val("")),!1},visitorWindowToggle:function(){var e=$(this),t=$(e).parent(".visitors-window");$(t).length>0&&$(t).toggleClass("open")}};$(document).ready(function(){});